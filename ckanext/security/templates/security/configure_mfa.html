{# (canada fork only): better setup pages #}
{# (canada fork only): 2.10 support, remove c #}
{% extends 'user/read_base.html' %}
{% import 'macros/form.html' as form %}

{% block subtitle %}{{ user_dict.display_name }} {{ g.template_title_delimiter }} {{ _('Configure two factor authentication') }}{% endblock %}
{% block breadcrumb_content %}
  <li><a href="{{ h.url_for('user.index') }}">{{ _('Users') }}</a></li>
  <li><a href="{{ h.url_for('user.read', id=user_dict.name) }}">{{ user_dict.display_name }}</a></li>
  <li class="active"><a href="#">{{ _('Configure two factor authentication') }}</a></li>
{% endblock %}

{% block secondary_content %}
  <section class="module module-narrow module-shallow">
    <h2 class="module-heading"><i class="fa fa-info-circle"></i> {{ _('Manage two factor authentication') }}</h2>
    <div class="module-content">
        <p>
            {% trans %}
            Scan the image with the two factor authentication app on your phone.
            {% endtrans %}
        </p>
    </div>
  </section>
{% endblock %}

{% block primary_content %}
    {% if totp_configured %}
      {% asset 'security/mfa_configure' %}
      <form id="mfa-form" method="POST">
        {# (canada fork only): 2.10 support #}
        {{ h.csrf_input() }}
          {# TODO: make layout better #}
            <fieldset>
                <legend>{{_('Scan this QR code with your two factor authentication app')}}</legend>

                <input id="totp-uri" type="hidden" disabled value="{{totp_challenger_uri}}"/>
                <div>
                    <canvas class="radius-lg padding-sm margin-b-sm border-solid" id="qr-code-container"></canvas>
                </div>
                <p>
                    {% trans %}If you are not able to scan the QR code, you can manually enter this secret into your authenticator app:{% endtrans %} <code id="totp-secret">{{totp_secret}}</code>
                </p>

                {{ form.input('mfa',
                    label=_("Enter the two factor authentication code from your app to test correct configuration"),
                    id='field-mfa',
                    type="text",
                    value="",
                    error=mfa_test_invalid,
                    classes=["control-medium"],
                    attrs={"autocomplete": "off", "class": "form-control"})
                }}
                <button class="btn btn-primary" type="submit">{{_('Test')}}</button>
            </fieldset>
      </form>
    <br/>
    {% set locale = h.dump_json({'content': _('Are you sure you want to generate a new two factor secret? This should only be necessary if you have deleted the authenticator app or are replacing your phone.')}) %}
    {% set new_mfa_challenge = h.url_for(controller='mfa_user', action='new', id=totp_user_id) %}
    <a class="btn btn-warning mrgn-tp-sm" style="display: inline-block;" href="{{new_mfa_challenge}}" data-module="confirm-action" data-module-i18n="{{ locale }}">{{_('Generate new two factor secret')}}</a>
    {% set locale = h.dump_json({'content': _('Are you sure you want to disable two factor authentication?')}) %}
    {% set disable_mfa_challenge = h.url_for(controller='mfa_user', action='disable', id=totp_user_id) %}
    <a class="btn btn-danger mrgn-tp-sm" style="display: inline-block;" href="{{disable_mfa_challenge}}" data-module="confirm-action" data-module-i18n="{{ locale }}">{{_('Disable two factor authentication')}}</a>
    {% else %}
      <br/>
      {% set locale = h.dump_json({'content': _('Are you sure you want to enable two factor authentication?')}) %}
      {% set new_mfa_challenge = h.url_for(controller='mfa_user', action='new', id=totp_user_id) %}
      <a class="btn btn-info" href="{{new_mfa_challenge}}" data-module="confirm-action" data-module-i18n="{{ locale }}">{{_('Enable two factor authentication')}}</a>
    {% endif %}
{% endblock %}
